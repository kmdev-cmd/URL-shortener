<!DOCTYPE html>
<html>
<head>
    <title>Teste API</title>
</head>
<body>
    <h1>Teste do Encurtador</h1>

    <h2>Teste Registro</h2>
    <button onclick="testRegister()">Registrar Usuário</button>
    <div id="register-result"></div>

    <h2>Teste Login</h2>
    <button onclick="testLogin()">Fazer Login</button>
    <div id="login-result"></div>

    <h2>Teste URLs (com token)</h2>
    <button onclick="testUrls()">Testar URLs</button>
    <div id="urls-result"></div>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';
        let authToken = null;

        async function testRegister() {
            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'email=teste2@teste.com&password=123456'
                });
                const result = await response.json();
                document.getElementById('register-result').textContent = JSON.stringify(result, null, 2);
                console.log('Registro:', result);
            } catch (error) {
                document.getElementById('register-result').textContent = 'Erro: ' + error.message;
                console.error('Erro registro:', error);
            }
        }

        async function testLogin() {
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'username=teste2@teste.com&password=123456'
                });
                const result = await response.json();
                document.getElementById('login-result').textContent = JSON.stringify(result, null, 2);
                if (result.access_token) {
                    authToken = result.access_token;
                    console.log('Login sucesso, token:', authToken);
                }
            } catch (error) {
                document.getElementById('login-result').textContent = 'Erro: ' + error.message;
                console.error('Erro login:', error);
            }
        }

        async function testUrls() {
            if (!authToken) {
                document.getElementById('urls-result').textContent = 'Faça login primeiro!';
                return;
            }

            console.log('Token sendo usado:', authToken);

            try {
                const response = await fetch(`${API_BASE}/urls/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json',
                    },
                });

                console.log('Status da resposta:', response.status);
                console.log('Headers da resposta:', response.headers);

                const text = await response.text();
                console.log('Resposta bruta:', text);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text}`);
                }

                const result = JSON.parse(text);
                document.getElementById('urls-result').textContent = JSON.stringify(result, null, 2);
                console.log('URLs:', result);
            } catch (error) {
                document.getElementById('urls-result').textContent = 'Erro: ' + error.message;
                console.error('Erro URLs:', error);
            }
        }
    </script>
</body>
</html>
